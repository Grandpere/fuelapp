name: Pull Request Checks

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  branch-up-to-date:
    name: Branch Up To Date
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Ensure branch contains latest main
        run: |
          set -euo pipefail
          git fetch origin main --depth=1
          MAIN_SHA="$(git rev-parse origin/main)"
          BASE_SHA="$(git merge-base HEAD origin/main)"

          if [ "$BASE_SHA" != "$MAIN_SHA" ]; then
            echo "Branch is behind main."
            echo "main:  $MAIN_SHA"
            echo "base:  $BASE_SHA"
            echo "Please rebase or merge main into this branch."
            exit 1
          fi

          echo "Branch is up to date with main."

  quality:
    name: Quality of Code
    runs-on: ubuntu-latest
    needs:
      - branch-up-to-date
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: ctype, iconv
          coverage: none
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache/files
            vendor
          key: ${{ runner.os }}-php-8.4-composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.4-composer-

      - name: Install dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: PHP CS Fixer (dry-run)
        run: vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php --dry-run --diff

      - name: PHPStan
        run: vendor/bin/phpstan analyse -c phpstan.dist.neon --memory-limit=2G --no-progress

      - name: PHPat (via PHPStan extension)
        run: vendor/bin/phpstan analyse -c phpstan.dist.neon tests/Architecture --memory-limit=2G --no-progress

  tests:
    name: Tests
    needs:
      - branch-up-to-date
    uses: ./.github/workflows/tests.yml
    with:
      ref: ${{ github.event.pull_request.head.sha }}
