{% extends 'base.html.twig' %}

{% block title %}Receipts{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .receipt-page {
            display: grid;
            gap: 1rem;
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .receipt-header p {
            margin: 0.35rem 0 0;
        }

        .receipt-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.8fr) minmax(320px, 0.9fr);
            gap: 1rem;
            align-items: start;
        }

        .panel {
            padding: 1rem;
        }

        .filters {
            display: grid;
            gap: 0.85rem;
        }

        .filters-row {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.65rem;
        }

        .columns-wrap {
            display: grid;
            gap: 0.7rem;
            margin-top: 0.2rem;
            padding: 0.8rem;
        }

        .checkbox-grid {
            display: grid;
            gap: 0.5rem 0.8rem;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            font-size: 0.84rem;
            color: #c6d6e2;
        }

        .checkbox-grid label {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
        }

        .checkbox-grid input[type="checkbox"] {
            accent-color: var(--primary);
        }

        .summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.7rem;
            margin-top: 0.8rem;
            color: var(--text-soft);
            font-size: 0.88rem;
        }

        .summary nav {
            display: flex;
            gap: 0.55rem;
        }

        .summary nav a {
            color: #ffd27a;
            text-decoration: none;
            font-weight: 700;
        }

        .side-panel {
            position: sticky;
            top: 1rem;
            display: grid;
            gap: 0.8rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .kpi-card {
            padding: 0.85rem;
        }

        .kpi-label {
            font-size: 0.74rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-soft);
        }

        .kpi-value {
            margin-top: 0.25rem;
            font-weight: 700;
            font-family: "Space Grotesk", sans-serif;
            font-size: 1.02rem;
        }

        .empty-state {
            margin-top: 0.8rem;
            padding: 0.85rem;
            border-radius: 10px;
            border: 1px dashed rgba(147, 178, 198, 0.35);
            color: var(--text-soft);
        }

        @media (max-width: 1180px) {
            .receipt-grid {
                grid-template-columns: 1fr;
            }

            .side-panel {
                position: static;
            }
        }

        @media (max-width: 900px) {
            .filters-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .checkbox-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 620px) {
            .receipt-header {
                flex-direction: column;
            }

            .filters-row {
                grid-template-columns: 1fr;
            }

            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <main class="app-shell receipt-page">
        {% if enableRealtime %}
            <turbo-stream-source src="{{ mercure(mercureTopic) }}"></turbo-stream-source>
        {% endif %}

        <section class="receipt-header">
            <div>
                <h1 class="page-title">Fuel Receipts</h1>
                <p class="muted">Track station spend, VAT and consumption in one operational view.</p>
            </div>
            <a class="btn btn-primary" href="{{ path('ui_receipt_new') }}" data-turbo-frame="receipt_form_frame">Add receipt</a>
        </section>

        {% for message in app.flashes('success') %}
            <div class="flash">{{ message }}</div>
        {% endfor %}

        <section class="card panel">
            <form method="get" action="{{ path('ui_receipt_index') }}" class="filters">
                <div class="filters-row">
                    <label class="label">
                        Station
                        <select class="select" name="station_id">
                            <option value="">All</option>
                            {% for option in stationOptions %}
                                <option value="{{ option.id }}" {% if filters.stationId == option.id %}selected{% endif %}>{{ option.label }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="label">
                        Issued from
                        <input class="input" type="text" name="issued_from" value="{{ filters.issuedFrom }}" data-datepicker="date" autocomplete="off">
                    </label>
                    <label class="label">
                        Issued to
                        <input class="input" type="text" name="issued_to" value="{{ filters.issuedTo }}" data-datepicker="date" autocomplete="off">
                    </label>
                    <label class="label">
                        Fuel type
                        <select class="select" name="fuel_type">
                            <option value="">All</option>
                            {% for fuelType in fuelTypeChoices %}
                                <option value="{{ fuelType }}" {% if filters.fuelType == fuelType %}selected{% endif %}>{{ fuelType|upper }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <div class="filters-row">
                    <label class="label">
                        Quantity min (mL)
                        <input class="input" type="number" name="quantity_min" value="{{ filters.quantityMin }}">
                    </label>
                    <label class="label">
                        Quantity max (mL)
                        <input class="input" type="number" name="quantity_max" value="{{ filters.quantityMax }}">
                    </label>
                    <label class="label">
                        Unit price min (deci-cents/L)
                        <input class="input" type="number" name="unit_price_min" value="{{ filters.unitPriceMin }}">
                    </label>
                    <label class="label">
                        Unit price max (deci-cents/L)
                        <input class="input" type="number" name="unit_price_max" value="{{ filters.unitPriceMax }}">
                    </label>
                </div>

                <div class="filters-row">
                    <label class="label">
                        Sort by
                        <select class="select" name="sort_by">
                            <option value="date" {% if filters.sortBy == 'date' %}selected{% endif %}>Date</option>
                            <option value="total" {% if filters.sortBy == 'total' %}selected{% endif %}>Total</option>
                            <option value="fuel_type" {% if filters.sortBy == 'fuel_type' %}selected{% endif %}>Fuel type</option>
                            <option value="quantity" {% if filters.sortBy == 'quantity' %}selected{% endif %}>Quantity</option>
                            <option value="unit_price" {% if filters.sortBy == 'unit_price' %}selected{% endif %}>Unit price</option>
                            <option value="vat_rate" {% if filters.sortBy == 'vat_rate' %}selected{% endif %}>VAT rate</option>
                        </select>
                    </label>
                    <label class="label">
                        Direction
                        <select class="select" name="sort_direction">
                            <option value="desc" {% if filters.sortDirection == 'desc' %}selected{% endif %}>Descending</option>
                            <option value="asc" {% if filters.sortDirection == 'asc' %}selected{% endif %}>Ascending</option>
                        </select>
                    </label>
                    <label class="label">
                        Per page
                        <select class="select" name="per_page">
                            {% for size in [10, 25, 50, 100] %}
                                <option value="{{ size }}" {% if perPage == size %}selected{% endif %}>{{ size }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="label">
                        VAT rate (%)
                        <input class="input" type="number" name="vat_rate" value="{{ filters.vatRate }}">
                    </label>
                </div>

                <div class="actions-row">
                    <button class="btn btn-primary" type="submit">Apply</button>
                    <a class="btn btn-secondary" href="{{ path('ui_receipt_index') }}">Reset</a>
                    <a class="btn btn-secondary" href="{{ path('ui_receipt_export', exportQueryParams) }}">Export CSV</a>
                </div>

                <fieldset class="card-subtle columns-wrap">
                    <legend class="muted">Columns (UI + export)</legend>
                    <label class="label" style="max-width: 260px;">
                        Preset
                        <select class="select" name="columns_preset" onchange="this.form.submit()">
                            {% for presetKey, presetLabel in columnPresetOptions %}
                                <option value="{{ presetKey }}" {% if filters.columnsPreset == presetKey %}selected{% endif %}>{{ presetLabel }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <div class="checkbox-grid">
                        {% for columnKey, columnLabel in columnOptions %}
                            <label>
                                <input type="checkbox" name="columns[]" value="{{ columnKey }}" {% if columnKey in visibleColumns %}checked{% endif %}>
                                {{ columnLabel }}
                            </label>
                        {% endfor %}
                    </div>
                </fieldset>
            </form>
        </section>

        <div class="receipt-grid">
            <section class="card panel">
                <div class="table-wrap">
                    <table class="app-table">
                        <thead>
                            <tr>
                                {% if 'id' in visibleColumns %}<th>Receipt ID</th>{% endif %}
                                {% if 'issued_at' in visibleColumns %}<th>Date</th>{% endif %}
                                {% if 'station_name' in visibleColumns %}<th>Station name</th>{% endif %}
                                {% if 'station_street_name' in visibleColumns %}<th>Street</th>{% endif %}
                                {% if 'station_postal_code' in visibleColumns %}<th>Postal code</th>{% endif %}
                                {% if 'station_city' in visibleColumns %}<th>City</th>{% endif %}
                                {% if 'fuel_type' in visibleColumns %}<th>Fuel</th>{% endif %}
                                {% if 'quantity_milli_liters' in visibleColumns %}<th style="text-align:right;">Quantity</th>{% endif %}
                                {% if 'unit_price_deci_cents_per_liter' in visibleColumns %}<th style="text-align:right;">Unit price</th>{% endif %}
                                {% if 'vat_rate_percent' in visibleColumns %}<th style="text-align:right;">VAT rate</th>{% endif %}
                                {% if 'total_cents' in visibleColumns %}<th style="text-align:right;">Total</th>{% endif %}
                                {% if 'vat_amount_cents' in visibleColumns %}<th style="text-align:right;">VAT</th>{% endif %}
                                <th style="text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="receipts_rows">
                            {% for receipt in receipts %}
                                {% include 'receipt/_row.html.twig' with { receipt: receipt, redirectUrl: app.request.uri, visibleColumns: visibleColumns } only %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if receipts is empty %}
                    <p id="receipts-empty" class="empty-state">No receipt yet.</p>
                {% endif %}

                <div class="summary">
                    <div>{{ total }} receipt(s) - page {{ page }} / {{ lastPage }}</div>
                    <nav>
                        {% if page > 1 %}
                            <a href="{{ path('ui_receipt_index', queryParams|merge({page: page - 1})) }}">Previous</a>
                        {% endif %}
                        {% if page < lastPage %}
                            <a href="{{ path('ui_receipt_index', queryParams|merge({page: page + 1})) }}">Next</a>
                        {% endif %}
                    </nav>
                </div>
            </section>

            <aside class="side-panel">
                <section class="card panel">
                    <div class="kpi-grid">
                        <article class="card-subtle kpi-card">
                            <div class="kpi-label">Rows</div>
                            <div class="kpi-value">{{ total }}</div>
                        </article>
                        <article class="card-subtle kpi-card">
                            <div class="kpi-label">Page size</div>
                            <div class="kpi-value">{{ perPage }}</div>
                        </article>
                    </div>
                    <p class="muted" style="margin: 0.9rem 0 0; font-size: 0.84rem;">Presets apply to both the table and CSV export.</p>
                </section>

                <section class="card panel">
                    <h2 class="page-title" style="font-size: 1.15rem; margin-bottom: 0.25rem;">New receipt</h2>
                    <p class="muted" style="margin-top: 0;">Create it inline without leaving this page.</p>
                    <turbo-frame id="receipt_form_frame">
                        <a class="btn btn-primary" href="{{ path('ui_receipt_new') }}" data-turbo-frame="receipt_form_frame">Load form</a>
                    </turbo-frame>
                </section>
            </aside>
        </div>
    </main>
{% endblock %}
